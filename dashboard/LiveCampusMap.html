<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live Campus Map</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }
    #map {
      height: 400px; /* Fits inside modal */
      width: 100%;
      border: 2px solid #ccc;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script type="module">
    import { Loader } from 'https://unpkg.com/@googlemaps/js-api-loader@1.16.2/dist/index.esm.js';

    // Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      onSnapshot, 
      query, 
      where 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDOaqfyMNW96fIeFxvXdZgzrnQ-bDZPgbU",
      authDomain: "camshield-50aec.firebaseapp.com",
      projectId: "camshield-50aec",
      storageBucket: "camshield-50aec.firebasestorage.app",
      messagingSenderId: "655472977777",
      appId: "1:655472977777:web:907fe040370301c08b78d0",
      measurementId: "G-W4N2BLCEL3"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let map;
    let markers = { markers: [], sos: [] };
    let infoWindow;

    const loader = new Loader({
      apiKey: "AIzaSyA3_P8EIN0I1IJv0j9cP7WZdhdOZyXHgGQ",
      version: "weekly",
    });

    async function initMap() {
      try {
        const { Map } = await loader.importLibrary("maps");

        // INTI Nilai campus default
        map = new Map(document.getElementById("map"), {
          center: { lat: 2.813954, lng: 101.757805 },
          zoom: 18,
        });

        infoWindow = new google.maps.InfoWindow();

        watchMarkers();
        watchSOS();
        watchWalkWithMe();

        if (window.parent) {
          window.parent.postMessage({ type: 'mapLoaded' }, '*');
        }
      } catch (error) {
        console.error("Error loading Google Maps API:", error);
      }
    }

    // Choose custom icon for each marker type
    function getMarkerIcon(type) {
      switch (type?.toLowerCase()) {
        case "camera":
          return {
            url: "https://img.freepik.com/premium-vector/cctv-logo_535345-1808.jpg",
            scaledSize: new google.maps.Size(20, 20),
          };
        case "emergency equipment":
          return {
            url: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTYAfw5BCHFw5XdId10eb0KljXOxdSrbbPcXQ&s",
            scaledSize: new google.maps.Size(20, 20),
          };
        case "guard post":
          return {
            url: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRgSXyk9gRsvfbk_Xh3XPnxDQfPUlTg_zhBrQ&s",
            scaledSize: new google.maps.Size(20, 20),
          };
        default:
          return "http://maps.google.com/mapfiles/ms/icons/red-dot.png"; // fallback
      }
    }

    // Load "Markers" collection
    function watchMarkers() {
      const ref = collection(db, "Markers");
      onSnapshot(ref, (snapshot) => {
        markers.markers.forEach(m => m.setMap(null));
        markers.markers = [];

        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          if (data.lat && data.lng) {
            const marker = new google.maps.Marker({
              position: { lat: Number(data.lat), lng: Number(data.lng) },
              map: map,
              title: data.type || "Marker",
              icon: getMarkerIcon(data.type)
            });

            marker.addListener("click", () => {
              const content = `
                <div style="min-width:150px">
                  <b>Type:</b> ${data.type || "N/A"}<br>
                  <b>Lat:</b> ${data.lat}<br>
                  <b>Lng:</b> ${data.lng}
                </div>
              `;
              infoWindow.setContent(content);
              infoWindow.open(map, marker);
            });

            markers.markers.push(marker);
          }
        });
      });
    }

    function extractLatLng(data) {
  if (data.location && typeof data.location.latitude === "number" && typeof data.location.longitude === "number") {
    return { lat: data.location.latitude, lng: data.location.longitude };
  } else if (typeof data.latitude === "number" && typeof data.longitude === "number") {
    return { lat: data.latitude, lng: data.longitude };
  }
  return null; // no valid location
}

    function watchSOS() {
  const ref = query(collection(db, "SOS"), where("status", "==", "Pending"));

  onSnapshot(ref, (snapshot) => {
    markers.sos.forEach(m => m.setMap(null));
    markers.sos = [];

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const coords = extractLatLng(data);

      if (!coords) {
        console.warn("SOS has no valid location:", docSnap.id);
        return;
      }

      const marker = new google.maps.Marker({
        position: coords,
        map,
        title: "SOS Alert",
        icon: {
          url: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTbkyhsZQ9itQiQGDQTR7V3fLB4kLth8i2nzw&s",
          scaledSize: new google.maps.Size(30, 30),
        }
      });

      marker.addListener("click", () => {
        infoWindow.setContent(`
          <div>
            <b>ðŸš¨ SOS Alert ðŸš¨</b><br>
            <b>Status:</b> ${data.status || "Unknown"}<br>
            <b>Type:</b> ${data.type || "N/A"}<br>
            <b>Lat:</b> ${coords.lat}<br>
            <b>Lng:</b> ${coords.lng}
          </div>
        `);
        infoWindow.open(map, marker);
      });

      markers.sos.push(marker);
    });
  });
}

function watchWalkWithMe() {
  const ref = query(
    collection(db, "SOS"),
    where("type", "==", "walk_with_me"),
    where("status", "==", "Pending")
  );

  onSnapshot(ref, (snapshot) => {
    snapshot.docChanges().forEach((change) => {
      const data = change.doc.data();
      const id = change.doc.id;

      if (change.type === "added") {
        const coords = extractLatLng(data);
        if (!coords) return;

        markers[id] = new google.maps.Marker({
          position: coords,
          map,
          icon: {
            url: "https://static.vecteezy.com/system/resources/previews/055/594/116/non_2x/walk-silhouette-icon-illustration-vector.jpg",
            scaledSize: new google.maps.Size(40, 40),
          },
          title: `Walk With Me: ${data.name || "Unknown"}`
        });
      }

      if (change.type === "removed" && markers[id]) {
        markers[id].setMap(null);
        delete markers[id];
      }
    });
  });
}

    window.addEventListener('load', initMap);
  </script>
</body>
</html>
